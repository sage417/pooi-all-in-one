name: Gitea Actions Demo
run-name: ${{ gitea.actor }} is testing out Gitea Actions ğŸš€
on: [push]

jobs:
  Explore-Gitea-Actions:
    runs-on: ubuntu-22.04
    # container:  # Specifies the container to run the job inside
    #   image: catthehacker/ubuntu:act-latest  # The Docker image to use as the container
    strategy:  # Strategy for the job execution
      matrix:  # Allows running jobs with different variations
        arch: [amd64]
    env:
      DOCKER_API_VERSION: 1.43
      BUILD_DIR: ${{ gitea.workspace }}/pooi-parent
      DOCKER_CONTEXT_DIR: ${{ env.BUILD_DIR }}/docker-context
      DOCKER_FILE_PATH: ${{env.BUILD_DIR}}/workflow/Dockerfile
    steps:
      - run: echo "ğŸ‰ The job was automatically triggered by a ${{ gitea.event_name }} event."
      - run: echo "ğŸ§ This job is now running on a ${{ runner.os }} server hosted by Gitea!"
      - run: echo "ğŸ” The name of your branch is ${{ gitea.ref }} and your repository is ${{ gitea.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v4
      - run: echo "ğŸ’¡ The ${{ gitea.repository }} repository has been cloned to the runner."
      - run: echo "ğŸ–¥ï¸ The workflow is now ready to test your code on the runner."
      - name: List files in the repository
        run: |
          ls ${{ gitea.workspace }}
      - run: echo "ğŸ This job's status is ${{ job.status }}."
      - name: Download jdk21 install package
        run: |
          download_url="https://mirrors.tuna.tsinghua.edu.cn/Adoptium/21/jdk/x64/linux/OpenJDK21U-jdk_x64_linux_hotspot_21.0.10_7.tar.gz"
          wget -t 2 -T 60 -q -O $RUNNER_TEMP/java_package.tar.gz $download_url
          if [ ! -f $RUNNER_TEMP/java_package.tar.gz ]; then
            echo "âŒ JDK å®‰è£…åŒ…ä¸‹è½½å¤±è´¥"
            exit 1
          fi
      - name: Setup-java21
        uses: actions/setup-java@v5
        with:
          distribution: 'jdkfile'
          jdkFile: ${{ runner.temp }}/java_package.tar.gz
          java-version: '21'
          architecture: x64
          cache: 'maven'
          cache-dependency-path: ${{ env.BUILD_DIR }}/pom.xml # optional
      - run: chmod +x "${BUILD_DIR}/mvnw"
      - name: Build Spring Boot jar package
        run: |
          cd ${BUILD_DIR}
          ./mvnw clean package -T 1C -DskipTests -pl workflow -am
      - name: Find build jar
        id: find_jar
        run: |
          PACKAGE_PATH=$(find ${BUILD_DIR} -name "package.jar" -path "*/target/*")
            if [ -z "$PACKAGE_PATH" ]; then
              echo "âŒ æœªæ‰¾åˆ°ç¼–è¯‘åçš„ JAR åŒ…"
              exit 1
            fi
            echo "PACKAGE_PATH=$PACKAGE_PATH" >> $GITHUB_OUTPUT
            echo "âœ… ç¼–è¯‘æˆåŠŸ JAR åŒ…è·¯å¾„ï¼š$PACKAGE_PATH"
      - name: Prepare Docker build context
        run: |
          mkdir -p ${DOCKER_CONTEXT_DIR}
          cp ${{ steps.find_jar.outputs.PACKAGE_PATH }} ${DOCKER_CONTEXT_DIR}/

          if [ -f ${DOCKER_FILE_PATH} ]; then
            cp ${DOCKER_FILE_PATH} ${DOCKER_CONTEXT_DIR}/
            echo "âœ… å¤åˆ¶ Dockerfile åˆ° Docker ä¸Šä¸‹æ–‡ç›®å½•"
          else
            echo "âŒ æœªæ‰¾åˆ° Dockerfileï¼ˆè·¯å¾„ï¼š${DOCKER_FILE_PATH}ï¼‰"
            exit 1
          fi
          
          echo "List files in the DOCKER_CONTEXT_DIR"
          ls -la ${DOCKER_CONTEXT_DIR}
      - name: Login to Container Registry
        uses: docker/login-action@v3  # Uses an action to perform the login
        with:  # Inputs to the login-action
          registry: https://gitea.pooi.app # Specifies the registry to log in to. You can set a variable or just hardcode this value.
          username: ${{ secrets.REGISTRY_USERNAME }}  # Docker Hub username from secrets
          password: ${{ secrets.REGISTRY_TOKEN }}  # Docker Hub token/password from secrets
      - name: Set up Docker Buildx  # Step to set up Docker Buildx
        uses: docker/setup-buildx-action@v3  # Uses an action to set up Buildx
      - name: Get base image digest  # Step to get the digest of the base image
        id: base-image-digest  # Sets an ID for this step to refer to its outputs
        run: echo "::set-output name=digest::$(docker pull docker.gitea.com/runner-images:ubuntu-22.04 | grep -Eo 'sha256:[a-f0-9]+' | cut -d ':' -f 2)"  # Pulls base image and extracts digest
      - name: Get current date and time  # Step to get the current date and time
        id: current-date-time  # Sets an ID for this step to refer to its outputs
        run: echo "::set-output name=rfc3339::$(date -u +'%Y-%m-%dT%H:%M:%SZ')"  # Gets current date/time in RFC 3339 format
      - name: Build Docker image  # Step to build and push the Docker image
        uses: docker/build-push-action@v6  # Uses an action to build and push Docker images
        with:  # Inputs to the build-push-action
          context: ${{ env.DOCKER_CONTEXT_DIR }}  # Specifies the build context
          push: true  # Enables pushing the built image to a registry
          tags: gitea.pooi.app/pooi/workflow-core:latest  # You can set a variable or just hardcode the tag depending on your needs.
          platforms: linux/amd64  # Specifies the target platforms for the image
          build-args: |  # Specifies build arguments
            TARGETARCH=${{ matrix.arch }}  # Sets the TARGETARCH build argument
            BASE_IMAGE_DIGEST=${{ steps.base-image-digest.outputs.digest }}  # Sets the BASE_IMAGE_DIGEST build argument
            IMAGE_CREATED=${{ steps.current-date-time.outputs.rfc3339 }}  # Sets the IMAGE_CREATED build argument